<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
<!--        <script th:inline="javascript">-->
<!--            let socket;-->

<!--            // 페이지 로드 시 WebSocket 연결-->
<!--            window.onload = function() {-->

<!--                // WebSocket 서버 URL (포트 번호는 서버에 맞게 수정)-->
<!--                socket = new WebSocket("ws://localhost:8083/test");-->

<!--                // WebSocket 연결이 열리면-->
<!--                socket.onopen = function() {-->
<!--                    console.log("WebSocket 연결 성공");-->
<!--                };-->
<!--                socket.onmessage = function(event) {-->
<!--                    const message = event.data;-->

<!--                    try {-->
<!--                        const jsonResponse = JSON.parse(message);-->
<!--                        const unreadCount = jsonResponse.unreadCount;-->

<!--                        const messagesContainer = document.getElementById("messagesContainer");-->
<!--                        messagesContainer.textContent = unreadCount;-->

<!--                    } catch (e) {-->
<!--                        console.error("메시지 파싱 실패:", e);-->
<!--                    }-->
<!--                };-->

<!--                // WebSocket 오류 발생 시-->
<!--                socket.onerror = function(error) {-->
<!--                    console.error("WebSocket 오류:", error);-->
<!--                    alert("WebSocket 오류 발생: " + error.message);-->
<!--                };-->

<!--                // WebSocket 연결이 닫히면-->
<!--                socket.onclose = function(event) {-->
<!--                    if (event.wasClean) {-->
<!--                        console.log("WebSocket 연결 종료 (정상 종료)");-->
<!--                    } else {-->
<!--                        console.error("WebSocket 연결 종료 (비정상 종료)");-->
<!--                        alert("WebSocket 연결이 비정상적으로 종료되었습니다. 코드: " + event.code + ", 이유: " + event.reason);-->
<!--                    }-->
<!--                };-->
<!--            };-->

<!--            function readMessage(msIdx, receiverNick) {-->
<!--                var message = {-->
<!--                    action:"read",-->
<!--                    msIdx: msIdx,-->
<!--                    receiverNick: receiverNick-->
<!--                };-->
<!--                socket.send(JSON.stringify(message));-->
<!--            }-->

<!--&lt;!&ndash;                // 메세지를 수신했을때&ndash;&gt;-->
<!--&lt;!&ndash;                socket.onmessage = function(event) {&ndash;&gt;-->
<!--&lt;!&ndash;                    const message = event.data;&ndash;&gt;-->
<!--&lt;!&ndash;                    console.log("수신된 메시지:", message);&ndash;&gt;-->

<!--&lt;!&ndash;                    // 메시지를 페이지에 표시&ndash;&gt;-->
<!--&lt;!&ndash;                    const messagesContainer = document.getElementById("messagesContainer");&ndash;&gt;-->
<!--&lt;!&ndash;                    const messageElement = document.createElement("div");&ndash;&gt;-->
<!--&lt;!&ndash;                    messageElement.textContent = message; // 수신된 메시지를 표시&ndash;&gt;-->
<!--&lt;!&ndash;                    messagesContainer.appendChild(messageElement);&ndash;&gt;-->

<!--&lt;!&ndash;                    alert("서버 응답: " + message); // 수신된 메시지 알림&ndash;&gt;-->
<!--&lt;!&ndash;                };&ndash;&gt;-->

<!--             function readMessage(msIdx, receiverNick) {-->
<!--                var message = {-->
<!--                    action:"read",-->
<!--                    msIdx: msIdx,-->
<!--                    receiverNick: receiverNick-->
<!--                };-->
<!--                socket.send(JSON.stringify(message));-->
<!--            }-->


<!--&lt;!&ndash;            function openNewWindow(idx){&ndash;&gt;-->
<!--&lt;!&ndash;                window.open("/messages/view?msidx=" + idx, "popup",&ndash;&gt;-->
<!--&lt;!&ndash;                   'width=600,height=500');&ndash;&gt;-->
<!--&lt;!&ndash;            }&ndash;&gt;-->

<!--            function openNewWindow(idx, receiverNick){-->
<!--&lt;!&ndash;                alert(idx + receiverNick);&ndash;&gt;-->

<!--                window.open("/messages/view?msidx=" + idx, "popup",-->
<!--                   'width=600,height=500');-->

<!--                var message = {-->
<!--                    action:"read",-->
<!--                    msIdx: idx,-->
<!--                    receiverNick: receiverNick-->
<!--                };-->

<!--                socket.send(JSON.stringify(message));-->

<!--            }-->
<!--        </script>-->
        <script th:inline="javascript">
            let socket;

            // 페이지 로드 시 WebSocket 연결
            window.onload = function() {

                // WebSocket 서버 URL (포트 번호는 서버에 맞게 수정)
                socket = new WebSocket("ws://localhost:8083/test");

                // WebSocket 연결이 열리면
                socket.onopen = function() {
                    console.log("WebSocket 연결 성공");
                };
                socket.onmessage = function(event) {
                    const message = event.data;

                    try {
                        const jsonResponse = JSON.parse(message);
                        const unreadCount = jsonResponse.unreadCount;

                        const messagesContainer = document.getElementById("messagesContainer");
                        messagesContainer.textContent = unreadCount;

                    } catch (e) {
                        console.error("메시지 파싱 실패:", e);
                    }

                    location.reload();
                };

                // WebSocket 오류 발생 시
                socket.onerror = function(error) {
                    console.error("WebSocket 오류:", error);
                    alert("WebSocket 오류 발생: " + error.message);
                };

                // WebSocket 연결이 닫히면
                socket.onclose = function(event) {
                    if (event.wasClean) {
                        console.log("WebSocket 연결 종료 (정상 종료)");
                    } else {
                        console.error("WebSocket 연결 종료 (비정상 종료)");
                        alert("WebSocket 연결이 비정상적으로 종료되었습니다. 코드: " + event.code + ", 이유: " + event.reason);
                    }
                };
            };

            function openReplyMessage(receiver){

                window.open("/messages/form?receiver=" + receiver, "popup",
                   'width=600,height=500');
            }

            function openViewMessage(idx, receiverNick){

                window.open("/messages/view?msidx=" + idx, "popup",
                   'width=600,height=500');

                var message = {
                    action:"read",
                    msIdx: idx,
                    receiverNick: receiverNick
                };

                socket.send(JSON.stringify(message));
            }
        </script>
            <link th:href="@{/css/Header.css}" rel="stylesheet" />
            <link th:href="@{/css/Footer.css}" rel="stylesheet" />
            <link th:href="@{/css/Mypage.css}" rel="stylesheet" />
            <style>
                table {
                    border-collapse: collapse;
                    width: 100%;
                    border-radius: 15px;
                    overflow:hidden
                }
                .table tr {
                    border-bottom: 1px solid #ddd; /* 테두리 가볍게 설정 */
                }
            </style>
        </head>
        <body>
            <div th:replace="~{Front/Header :: header}"></div>

            <div class="mypage-container">
                <div class="sidebar">
                    <h3>나의 쪽지함</h3>
                    <br/>
                    <ul>
                        <li><a href="/messages/list"><b>받은 쪽지함</b> <b id="messagesContainer" style="color:green;" th:text="${count} == 0  ? '' : ${count}"> </b> </a></li>
                        <li><a href="/messages/sentlist">보낸 쪽지함</a></li>
                    </ul>

                    <hr>
                </div>

                <div class="w-100">
                    <h4>받은 쪽지함</h4>
                    <!--                <div id="messagesContainer" th:text="${count}"></div>-->
                    <!--                <div id="messagesContainer" ></div>-->
                    <!--            <button type="button" class="btn btn-outline-success position-relative">-->
                    <!--                <i class="fa-regular fa-comments"></i>-->
                    <!--                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="messagesContainer" th:text="${count}" ></span>-->
                    <!--            </button>-->
                    <table class="table table-borderless table-hover ">
                        <colgroup>
                            <col width="60px"/>
                            <col width="120px" />
                            <col width="30px" />
                            <col width="*" />
                            <col width="180px" />
                            <col width="100px" />
                        </colgroup>
                        <thead>
                        <tr class="text-center" style="background-color: #C1E2A4; ">
                            <th>번호</th>
                            <th>보낸 사람</th>
                            <th></th>
                            <th>제목</th>
                            <th>날짜</th>
                            <th>답장</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${messageList == null} or ${messageList.size() == 0}" >
                            <td colspan="5"  class="text-center">
                                쪽지가 없습니다.
                            </td>
                        </tr>
                        <tr th:each="list : ${messageList}">
                            <td class="text-center" th:text="${totalCount - ((currentPage -1) * pageSize) - listStat.index}">1</td>
                            <td class="text-center" th:text="${list.sender}"></td>
                            <td th:if="${list.readstatus == 0}"><i class="bi bi-envelope"></i></td>
                            <td th:unless="${list.readstatus == 0}"><i class="bi bi-envelope-open"></i></td>
                            <td class="text-left">
                                <!--                        <a th:text="${list.title}" th:onclick="|openNewWindow('${list.msidx}')|">gd</a>-->
                                <a th:text="${list.title}" th:attr="onclick=|openViewMessage('${list.msidx}','${list.receiver}')|" >쪽지 제목</a>
                            </td>
                            <td class="text-center" th:text="${#temporals.format(list.createDate, 'yyyy-MM-dd hh:ss')}"></td>
                            <!--                    <td class="text-center"><button type="button" class="btn btn btn-outline-success btn-sm" onclick="openReplyMessage();">답장</button></td>-->
                            <td class="text-center"><button type="button" class="btn btn btn-outline-success btn-sm" th:attr="onclick=|openReplyMessage('${list.sender}')|">답장</button></td>
                        </tr>
                        </tbody>
                    </table>
                    <nav aria-label="Page navigation example" class="d-flex justify-content-center" th:if="${totalPage > 0}">
                        <ul class="pagination">
                            <!-- 이전 버튼: 현재 페이지가 1보다 크면 활성화 -->
                            <li th:if="${currentPage > 1}" class="page-item">
                                <a class="page-link" th:href="@{/salesboard(page='1', searchField=${searchField}, searchWord=${searchWord})}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <li th:if="${currentPage > 1}" class="page-item">
                                <a class="page-link" th:href="@{/salesboard(page=${currentPage - 1}, searchField=${searchField}, searchWord=${searchWord})}" aria-label="Previous">
                                    <span aria-hidden="true">&lsaquo;</span>
                                </a>
                            </li>

                            <!-- 페이지 번호 리스트 -->
                            <li th:each="page : ${#numbers.sequence(currentGroup * 5 + 1, totalPage)}"
                                th:if="${page <= (currentGroup + 1) * 5}"
                                th:classappend="${page == currentPage} ? 'active' : ''" class="page-item">
                                <a th:href="@{/messages/list(page=${page})}" th:text="${page}" class="page-link"></a>
                            </li>

                            <!-- 다음 버튼: 현재 페이지가 마지막 페이지보다 작으면 활성화 -->
                            <li th:if="${currentPage < totalPage}" class="page-item">
                                <a class="page-link" th:href="@{/salesboard(page=${currentPage + 1}, searchField=${searchField}, searchWord=${searchWord})}" aria-label="Next">
                                    <span aria-hidden="true">&rsaquo;</span>
                                </a>
                            </li>

                            <li th:if="${currentPage < totalPage}" class="page-item">
                                <a class="page-link" th:href="@{/salesboard(page=${totalPage}, searchField=${searchField}, searchWord=${searchWord})}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            <div th:replace="~{Front/Footer :: footer}"></div>
        </body>
    </html>