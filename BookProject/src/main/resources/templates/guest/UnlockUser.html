<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>계정 잠금 해제</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2>계정 잠금 해제</h2>
    <form>
        <div class="mb-3">
            <label for="unlock-name" class="form-label">이름</label>
            <input type="text" class="form-control" id="unlock-name" name="name" required>
        </div>
        <div class="mb-3">
            <label for="unlock-id" class="form-label">아이디</label>
            <input type="text" class="form-control" id="unlock-id" name="id" required>
        </div>
        <div class="mb-3">
            <label for="unlock-phone" class="form-label">전화번호</label>
            <input type="tel" class="form-control" id="unlock-phone" name="phone" required>
        </div>
        <div class="mb-3">
            <label for="unlock-email" class="form-label">이메일</label>
            <input type="email" class="form-control" id="unlock-email" name="email" required>
            <button type="button" class="btn btn-secondary" id="send-unlock-code">인증번호 발송</button>
        </div>
        <div class="mb-3" id="unlock-code-section" style="display:none;">
            <label for="unlock-code" class="form-label">인증번호</label>
            <input type="text" class="form-control" id="unlock-code" required>
            <button type="button" class="btn btn-secondary mt-2" id="verify-unlock-code">인증번호 확인</button>
        </div>
    </form>
    <div th:if="${successMessage}" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" th:text="${errorMessage}"></div>
</div>

<script>
    $('#send-unlock-code').click(function () {
      var name = $('#unlock-name').val();
      var email = $('#unlock-email').val();
      var id = $('#unlock-id').val();
      var phone = $('#unlock-phone').val();

      $.ajax({
        url: '/guest/sendUnlockCode',
        type: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({ name: name, email: email, id: id, phone: phone }),
        success: function (response) {
          if (response.success) {
            alert('인증번호가 발송되었습니다.');
            $('#unlock-code-section').show();
          } else {
            alert('일치하는 정보를 찾을 수 없습니다.');
          }
        }
      });
    });

    $('#verify-unlock-code').click(function () {
      var authCode = $('#unlock-code').val();
      var email = $('#unlock-email').val();

      $.ajax({
        url: '/guest/verifyUnlockCode',
        type: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({ authCode: authCode, email: email }),
        success: function (response) {
          if (response.verified) {
            alert('인증이 완료되었습니다. 계정 잠금이 해제됩니다.');
            $.ajax({
              url: '/guest/unlockAccount',
              type: 'POST',
              contentType: 'application/json',
              dataType: 'json',
              data: JSON.stringify({ email: email }),
              success: function () {
                alert('계정 잠금이 해제되었습니다.');
                window.location.href = '/login';
              }
            });
          } else {
            alert('인증번호가 일치하지 않습니다.');
          }
        }
      })
